Class Port.SourceControl.Config Extends %SYSTEM.Help
{

/// Sets the log level used to display the info. Ranging from 1 to 3, greater is more detailed.
ClassMethod SetLogLevel(logLevel As %Integer) As %Status
{
  if '$isvalidnum(logLevel) {
    quit $$$ERROR($$$GeneralError, "Log level must be a number between 0 and 2.")
  }
  if logLevel > 0 && (logLevel < 3) {
    set ^Port.SourceControl.Settings("general.logLevel") = logLevel
    quit $$$OK
  }
  quit $$$ERROR($$$GeneralError, "Log level out of range.")
}

/// Gets the current configured log level.
ClassMethod GetLogLevel() As %Status
{
  quit $get(^Port.SourceControl.Settings("general.logLevel"), 0)
}

/// Sets the path where the files are to be exported. Supports template.
ClassMethod SetExportPath(newExportPath As %String) As %String
{
  set ^Port.SourceControl.Settings("source.path") = $get(newExportPath, "/CacheProjects/{NAMESPACE}/{PROJECT}")
}

/// Gets the resolved export path. Pass 1 to excludeProject to return the project's parent directory.
ClassMethod GetExportPath(excludeProject As %Boolean = 0) As %String
{
  quit ..rewritePlaceHolders($get(^Port.SourceControl.Settings("source.path")), excludeProject)
}

/// Sets the path which the source control should export and look up for tests on XML format.
ClassMethod SetTestPath(newPath As %String)
{
  
  set ^Port.SourceControl.Settings("test.path") = $get(newPath, "__tests__/cls")
}

/// Gets the resolved test path.
ClassMethod GetTestPath() As %String
{
  quit ..rewritePlaceHolders($get(^Port.SourceControl.Settings("test.path")))
}

/// Informs the source control to run associated test class when the source is compiled.
ClassMethod EnableTestOnDemand()
{
  set ^Port.SourceControl.Settings("test.ondemand") = 1
}

/// Disables the test class association.
ClassMethod DisableTestOnDemand()
{
  set ^Port.SourceControl.Settings("test.ondemand") = 0
}

/// Returns 1 if association is enabled, 0 if not.
ClassMethod IsTestOnDemandEnabled() As %String
{
  quit ($get(^Port.SourceControl.Settings("test.ondemand")) = 1)
}

/// Forces the source control to skip class exportation if source is not covered by it's test class.
ClassMethod EnableExportOnlyAssertedClass()
{
  set ^Port.SourceControl.Settings("test.exportAsserted") = 1
}

/// Disable test class constraint, allowing the source to be exported regardless of having a test class.
ClassMethod DisableExportOnlyAssertedClass()
{
  set ^Port.SourceControl.Settings("test.exportAsserted") = 0
}

/// Returns 1 if constraint is enabled, 0 if not.
ClassMethod IsClassAssertionRequired() As %Boolean
{
  quit ($get(^Port.SourceControl.Settings("test.exportAsserted")) = 1)
}

/// Sets the prefix used to associate the source with it's test class.
ClassMethod SetTestClassPrefix(newPrefix As %String)
{
  set ^Port.SourceControl.Settings("test.prefix") = newPrefix
}

/// Gets the association prefix.
ClassMethod GetTestClassPrefix() As %String
{
  quit $get(^Port.SourceControl.Settings("test.prefix"))
}

/// Sets a VCS (version control system) command. Supports template.
ClassMethod SetVCSCommand(command As %String, args As %Status = "")
{
  set ^Port.SourceControl.Settings("vcs.command", command) = args
}

/// Gets the resolved VCS command.
ClassMethod GetVCSCommand(command As %String, args... As %String)
{
  quit ..rewritePlaceHolders($get(^Port.SourceControl.Settings("vcs.command", command)), 0, args...)
}

/// Sets the VCS executable path. Supports template.
ClassMethod SetVCSPath(vcsPath As %String)
{
  set ^Port.SourceControl.Settings("vcs.path") = vcsPath
}

/// Gets the resolved VCS executable path.
ClassMethod GetVCSPath(fullFilePath As %String)
{
  quit ..rewritePlaceHolders($get(^Port.SourceControl.Settings("vcs.path")))
}

/// Registers a VCS extension to be used with the source control hook.
ClassMethod RegisterVCSHandler(vcs As %String) As %Status
{
  set ^Port.SourceControl.Settings("vcs.name") = vcs
}

/// Gets the extension class name.
ClassMethod GetVCSHandlerName() As %Status
{
  
  quit $get(^Port.SourceControl.Settings("vcs.name"))
}

/// Enables the VCS extension.
ClassMethod EnableVCS() As %Status
{
  if ..GetVCSHandlerName() = "" quit $$$ERROR($$$CacheError, "Unable to change VCS state: Missing VCS handler.")
  set ^Port.SourceControl.Settings("vcs.enabled") = 1
  quit $$$OK
}

/// Disables the VCS extension.
ClassMethod DisableVCS() As %Status
{
  if ..GetVCSHandlerName() = "" {
    quit $$$ERROR($$$CacheError, "Unable to change VCS state: Missing VCS handler.")
  }
  set ^Port.SourceControl.Settings("vcs.enabled") = 0
  quit $$$OK
}

/// Returns 1 if VCS is enabled, 0 if not.
ClassMethod IsVCSEnabled() As %Boolean
{
  quit ($get(^Port.SourceControl.Settings("vcs.enabled"), 0) && (..GetVCSHandlerName() '= ""))
}

ClassMethod rewritePlaceHolders(basePath As %String, excludeProject As %Boolean = 0, params... As %String) As %String [ Internal ]
{
  if '$data(params) set params = ""
  set translatedPath = basePath 
  #define RewriteIfPathContains(%expression, %replacement) set translatedPath = $select(translatedPath [ %expression : $replace(translatedPath, %expression, %replacement), 1: translatedPath) 
  
  set installDirectory = $System.Util.InstallDirectory()
  set installDirectory = $extract(installDirectory, 1, $length(installDirectory) - 1)
  $$$RewriteIfPathContains("{NAMESPACE}", $namespace)
  $$$RewriteIfPathContains("{INSTALLDIR}", installDirectory)
  $$$RewriteIfPathContains("{USERNAME}", $username) 
  $$$RewriteIfPathContains("{EXPORTPATH}", ..GetExportPath())
  $$$RewriteIfPathContains("{FULLEXPORTPATH}", ##class(%File).NormalizeFilename(..GetExportPath())) 
  $$$RewriteIfPathContains("{VCS}", ..GetVCSPath())
  $$$RewriteIfPathContains("{SLASH}", $select($$$isWINDOWS: "\", 1: "/"))
  if 'excludeProject $$$RewriteIfPathContains("{PROJECT}", $get(^||%Studio.Project))
  if params {
    for i=1:1:params $$$RewriteIfPathContains("{P"_i_"}", params(i))
  }
  quit translatedPath
}

}

